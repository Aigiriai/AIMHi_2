2025-08-21T12:46:41Z info: Creating Autoscale service
starting up user application
forwarding local port 5000 to external port 80 (mapped as 1104)
> rest-express@1.0.0 start
> NODE_ENV=production node dist/index.js
☁️ Object Storage backup service initialized
12:47:14 PM [express] 📦 Initializing unified database manager...
⚠️ DEPRECATED: sqlite-db.ts is deprecated. Use unified-db-manager.ts instead
⏱️ DB_MANAGER: Starting initialization with 15s timeout
  heapTotal: 68681728,
🔍 DB_MANAGER[qm8758980]: Current state - initialized: false, complete: false, initializing: false
📂 Multiple call contexts loaded from disk (1 candidates)
📁 DB_MANAGER: Database path: /home/runner/workspace/data/production.db (NODE_ENV: production)
✅ DB_MANAGER: Backup service loaded in 15ms
📊 DB_MANAGER: Environment - NODE_ENV: production, CWD: /home/runner/workspace
🌍 RESTORE: Environment: production
🔄 DB_MANAGER: Proceeding with smart database initialization...
12:47:14 PM [express] Initializing consolidated Node.js backend...
🛡️ Attempting to restore database from Object Storage...
✅ Downloaded 147456 bytes using downloadAsBytes method
  rss: 144285696,
🔄 RESTORE: Starting database restoration process...
🚀 DB_MANAGER[qm8758980]: Starting new initialization process...
🔄 Initializing call context on app startup...
  heapUsed: 42396224,
}
� DB_MANAGER: Starting unified database initialization...
🚀 DB_MANAGER: Racing initialization vs timeout...
🔍 DB_MANAGER[qm8758980]: Getting database instance (PID: 37)
✅ Downloaded 290816 bytes using downloadAsBytes method
🌍 DB_MANAGER: Environment: production
🏭 DB_MANAGER: Production mode - always attempt restore from latest backup first
12:47:14 PM [express] 🔗 AI calling configured for direct webhooks (no tunnel required)
☁️ Downloading database backup: database-backups/prod/pre-migration-production-2025-08-21T12-41-29-619Z.db
🔄 Restoring most recent backup: pre-migration-production-2025-08-21T12-41-29-619Z.db (modified: 1970-01-01T00:00:00.000Z)
🔄 DB_MANAGER: ========== BACKUP RESTORATION ATTEMPT ==========
📊 RESTORE: No existing database found at target path
☁️ RESTORE: Attempting restoration from Object Storage...
🔧 Preparing database for restoration - closing connections and cleaning up WAL files...
  external: 3943061,
✅ Database preparation complete - ready for restoration
🔍 DB_MANAGER: Integrity check result: ok
📁 RESTORE: Data directory already exists: /home/runner/workspace/data
12:47:14 PM [express] 🚀 SERVER: Starting server (database initializing in background)...
💾 DB_MANAGER: Memory usage before init: {
🎉 DB_MANAGER: ========== BACKUP RESTORATION SUCCESS! ==========
✅ DB_MANAGER: restoreFromLatestBackup completed in 673ms with result: true
📁 RESTORE: Target database path: /home/runner/workspace/data/production.db
✅ Downloaded 147456 bytes using downloadAsBytes method
🔄 Trying downloadAsBytes method as alternative...
  2. production-backup-2025-08-21T12-44-15-530Z.db (modified: 1970-01-01T00:00:00.000Z)
✅ DB_MANAGER: Table 'organizations' exists (0 records)
  arrayBuffers: 438362
💾 MIGRATION_SYSTEM: Creating backup at /home/runner/workspace/database-backup-production-2025-08-21T12-47-14-924Z.db...
  • Chaitanya Baitule (5%)
✅ Restored context for Sudhir from previous session
🔍 DEBUG: Organizations in restored backup: []
🔍 DB_MANAGER: Opening and validating existing database...
✅ DB_MANAGER: Table 'candidates' exists (0 records)
     📋 Organizations in production-backup-2025-08-21T12-44-15-530Z.db: AIM Hi System (aimhi.app), Aigiri (null)
📋 STARTUP_VALIDATOR: Table jobs has 25 columns
📁 DB_MANAGER: Target database path: /home/runner/workspace/data/production.db
☁️ Downloading database backup: database-backups/prod/pre-migration-production-2025-08-21T12-41-29-619Z.db
✅ RESTORE: Database successfully restored from Object Storage backup
⚠️  STARTUP_VALIDATOR: 1 essential columns missing from existing tables
📊 STARTUP_VALIDATOR: These issues will be resolved before serving any user requests
📋 Found 2 prod backup files, checking most recent:
📋 STARTUP_VALIDATOR: Checking for missing columns in existing tables...
✅ Database backup uploaded successfully: database-backups/prod/pre-migration-production-2025-08-21T12-47-14-924Z.db
🔍 DB_MANAGER: Checking essential table structure...
✅ Database backup downloaded successfully to: /tmp/debug_backup_0.db
🔄 DB_MANAGER: Calling restoreFromLatestBackup...
📋 STARTUP_VALIDATOR: Step 1/5 - Analyzing current database schema...
📦 DB_MANAGER: Loading backup restoration service...
📋 STARTUP_VALIDATOR: Table candidates has 14 columns
📂 Loaded 1 candidate contexts for AI calling
🔄 DB_MANAGER: Attempting restoration from latest production backup before any other action...
🔄 Trying downloadAsBytes method as alternative...
📋 STARTUP_VALIDATOR: Checking for missing columns in existing tables...
📊 DB_MANAGER: Last modified: 2025-08-21T12:47:14.908Z
🚀 MIGRATION_SYSTEM: Applying migration auto_migration_1755780435208...
☁️ MIGRATION_SYSTEM: Uploaded pre-migration backup to Object Storage as database-backups/prod/pre-migration-production-2025-08-21T12-47-14-924Z.db
   - Current tables: 23
✅ Database restored from most recent backup: pre-migration-production-2025-08-21T12-41-29-619Z.db
     1. Missing essential column: candidates.settings - required for candidate-specific configuration (TEXT/JSON, default: "{}") - with schema-validated datatypes
✅ DB_MANAGER: Table 'users' exists (0 records)
✅ Database backup downloaded successfully to: /tmp/debug_backup_1.db
🔄 Trying downloadAsBytes method as alternative...
🔍 STARTUP_VALIDATOR: Performing detailed schema analysis...
📊 STARTUP_VALIDATOR: Schema analysis complete - 1 issues identified for automatic resolution
📊 MIGRATION_SYSTEM: Schema analysis complete
📄 STARTUP_VALIDATOR: Backup creation skipped in current environment
🔄 MIGRATION_SYSTEM: Starting auto-migration for production environment
📋 STARTUP_VALIDATOR: Checking for missing tables...
✅ MIGRATION_SYSTEM: Migrations table ready
✅ Existing database connections closed and checkpointed
   - Missing tables: 0
🔍 DB_MANAGER: Performing integrity check...
📂 Call context loaded from disk
💾 DB_MANAGER: Memory usage after init: {
✅ DB_MANAGER: Restored database passed integrity check
✅ DB_MANAGER: Initialization completed successfully in 991ms
   - Missing columns: 1
💾 STARTUP_VALIDATOR: Step 2/5 - Creating safety backup before schema changes...
     📋 Organizations in pre-migration-production-2025-08-21T12-41-29-619Z.db: None
✅ STARTUP_VALIDATOR: All expected tables are present
  heapTotal: 75653120,
   - Needs migration: true
📄 STARTUP_VALIDATOR: Backup creation skipped (0ms) - appropriate for current environment
   - Missing tables: 0
   - Extra tables: 0
✅ DB_MANAGER: Table 'jobs' exists (0 records)
🔍 MIGRATION_SYSTEM: Checking for schema drift...
📁 DB_MANAGER: Database path: /home/runner/workspace/data/production.db
☁️ Uploading database backup: database-backups/prod/pre-migration-production-2025-08-21T12-47-14-924Z.db (144KB)
✅ MIGRATION_SYSTEM: Auto-migration completed successfully
   - Expected tables: 23
🗑️ STARTUP_VALIDATOR: Checking for extra tables that need cleanup...
🗑️ STARTUP_VALIDATOR: Checking for extra tables that need cleanup...
✅ DB_MANAGER: Successfully restored from backup
   - Current tables: 23
📋 STARTUP_VALIDATOR: Checking for missing tables...
✅ DB_MANAGER[qm8758980]: New initialization completed successfully (992ms)
📊 RESTORE: Restored database size: 144KB
⚠️  STARTUP_VALIDATOR: Found 1 schema issues requiring fixes:
🔧 STARTUP_VALIDATOR: Step 3/5 - Applying comprehensive schema migrations...
🎯 STARTUP_VALIDATOR: Database schema is now fully compatible with application code
  heapUsed: 48352608,
📊 DB_MANAGER: Database file size: 144KB
🗑️ MIGRATION_SYSTEM: Processing schema cleanup...
   - Schema cleanup: NO
✅ Database backup downloaded successfully to: /home/runner/workspace/data/production.db
✅ STARTUP_VALIDATOR: Database integrity check passed
🎉 STARTUP_VALIDATOR: Schema analysis complete - database is perfect!
🔍 MIGRATION_SYSTEM: Checking for schema drift...
📋 STARTUP_VALIDATOR: Table organizations has 18 columns
📋 STARTUP_VALIDATOR: Table users has 18 columns
12:47:14 PM [express] Server running on port 5000 with AI calling support
☁️ Downloading database backup: database-backups/prod/production-backup-2025-08-21T12-44-15-530Z.db
✅ DB_MANAGER: Restored production database validated successfully
✅ STARTUP_VALIDATOR: All expected tables are present
⚙️ DB_MANAGER: Configuring pragmas for existing database...
🎉 STARTUP_VALIDATOR: Schema validation completed successfully in 291ms
✅ MIGRATION_SYSTEM: Migration auto_migration_1755780435208 applied successfully
📋 STARTUP_VALIDATOR: Schema analysis completed in 2ms
   - Current tables: 23
✅ STARTUP_VALIDATOR: No extra tables found
🔍 DB_MANAGER: Verifying restored database integrity...
  1. pre-migration-production-2025-08-21T12-41-29-619Z.db (modified: 1970-01-01T00:00:00.000Z)
📋 STARTUP_VALIDATOR: Table candidates has 15 columns
   - Missing columns: candidates.settings
✅ STARTUP_VALIDATOR: All essential columns are present
  rss: 155688960,
   - Missing tables: 0
   - Description: Auto-generated schema alignment - 1 columns, 0 tables added, 0 tables removed
✅ MIGRATION_SYSTEM: Migration completed in 2ms
🔍 STARTUP_VALIDATOR: Performing detailed schema analysis...
  arrayBuffers: 767347
📊 MIGRATION_SYSTEM: Schema analysis complete
⚠️ MIGRATION_SYSTEM: Schema drift detected - applying fixes...
   - Description: Auto-generated schema alignment - 1 columns, 0 tables added, 0 tables removed
🔄 MIGRATION_SYSTEM: Generated comprehensive schema alignment migration:
12:47:14 PM [express] Direct webhook domain: aimhi.aigiri.ai
🔧 MIGRATION_SYSTEM: Initializing migrations table...
🔍 STARTUP_VALIDATOR: Performing database integrity check...
   - Environment: production
✅ STARTUP_VALIDATOR: No extra tables found
   - Version: 1
🔍 MIGRATION_SYSTEM: Checking for schema drift...
✅ STARTUP_VALIDATOR: All schema issues resolved successfully (verified in 1ms)
📋 STARTUP_VALIDATOR: Table jobs has 25 columns
✅ DB_MANAGER: Database integrity check passed
   - Executing: ALTER TABLE candidates ADD COLUMN settings TEXT DE...
📊 STARTUP_VALIDATOR: Applied 1 schema fixes automatically
   - Needs migration: true
📄 STARTUP_VALIDATOR: Step 5/5 - Backup update skipped (appropriate for current environment)
🔄 DB_MANAGER: Running schema validation on existing database...
   - Needs migration: false
✅ SCHEMA_MANAGER: Database schema is ready
📊 STARTUP_VALIDATOR: Found 23 existing tables
🚀 STARTUP_VALIDATOR: Application ready - zero runtime validation overhead guaranteed
   - Missing columns: 0
   - Missing tables: 
✅ DB_MANAGER: Database initialization completed successfully
🧹 DB_MANAGER[qm8758980]: Initialization mutex cleaned up
📊 STARTUP_VALIDATOR: Validation approach - startup-only (zero runtime overhead)
📋 STARTUP_VALIDATOR: Table organizations has 18 columns
✅ MIGRATION_SYSTEM: Backup created successfully
}
12:47:15 PM [express] ✅ DATABASE: Database initialization completed successfully
✅ DB_MANAGER: Existing database schema validation completed in 291ms
🔧 SCHEMA_MANAGER: Ensuring database schema for production environment
   - Extra tables: 0
🔍 STARTUP_VALIDATOR: Step 4/5 - Verifying migration success and schema integrity...
  external: 4487153,
🧹 DB_MANAGER: Timeout timers cleaned up after successful initialization
   - Missing columns: 1
📋 DB_MANAGER: Applied 1 schema fixes to existing database
📊 MIGRATION_SYSTEM: Schema analysis complete
✅ STARTUP_VALIDATOR: Migration system completed successfully in 287ms
   - Expected tables: 23
✅ STARTUP_VALIDATOR: Database integrity check passed
✅ DB_MANAGER: Existing database validated successfully in 292ms
🔍 STARTUP_VALIDATOR: Starting comprehensive schema validation for production environment
📊 STARTUP_VALIDATOR: Found 23 existing tables
📋 STARTUP_VALIDATOR: Table users has 18 columns
   - Expected tables: 23
   - Extra tables: 0
   - Up statements: 1
🔍 STARTUP_VALIDATOR: Performing database integrity check...
2025-08-21T12:47:18Z info: Waiting for service to be ready
2025-08-21T12:47:20Z info: Deployment successful